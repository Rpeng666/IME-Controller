# IME Controller (输入法状态控制器)

![License](https://img.shields.io/github/license/rpeng666/ime-controller)
![GitHub release (latest by date)](https://img.shields.io/github/v/release/rpeng666/ime-controller)

一个 Windows 系统托盘应用程序，用于智能控制输入法状态。解决 Windows 中文输入法在某些场景下频繁自动切换的苦恼，支持强制锁定中文或英文模式，并提供便捷的快捷键切换功能。

> 如果觉得有用的话，客官赏个star呗，蟹蟹 >_<

![](./docs/image.png)

## 主要特点

- 🎯 **实时强制检测**：每500毫秒检测一次输入法状态，确保"每时每刻"都符合设置
- 🔄 **双重保护机制**：窗口切换事件 + 定时检测，双重确保输入法状态正确
- ⌨️ **智能热键**：支持自定义快捷键，一键切换中英文模式
- 🔒 **模式锁定**：支持强制中文/英文模式，避免意外切换
- 🚫 **静默运行**：可选择关闭通知弹窗，专注工作不被打扰
- 🚀 **开机自启**：支持开机自动启动，启动时自动重试热键注册
- 🎛️ **托盘控制**：系统托盘图标动态切换，右键菜单快速操作
- 💾 **配置管理**：人性化的配置文件，支持热重载

## 功能特点

- [x] ⏱️ **实时强制检测**：每500毫秒主动检测输入法状态，确保"每时每刻"都符合配置
- [x] 🔄 **双重保护机制**：窗口切换事件 + 定时检测，双重确保输入法状态正确
- [x] 🔒 **强制保持输入法语言状态**：支持中文/英文模式锁定
- [x] ⌨️ **全局热键支持**：默认 Alt+M 切换总开关，Alt+S 切换中英文
- [x] 🚀 **开机自启动选项**：通过注册表实现，兼容性好
- [x] 🔧 **系统托盘快捷操作**：动态图标显示状态
- [x] 📝 **持久化配置**：JSON格式，支持手动编辑
- [x] 🔕 **通知控制**：可选择是否显示状态切换通知
- [x] 🔄 **配置热重载**：修改配置后可即时生效
- [x] 📊 **详细日志记录**：便于调试和问题排查
- [ ] 🚫 **应用程序排除列表**：预留功能

## 核心特性：实时强制检测

> 🔥 **最新功能**：程序现在采用定时检测机制，每500毫秒主动检测当前输入法状态，一旦发现不符合配置，立即强制恢复！

### 检测机制
- **窗口切换检测**：当用户切换到不同程序窗口时触发
- **定时主动检测**：每500毫秒检测一次，无论是否切换窗口
- **双重保障**：两种机制并行工作，确保输入法状态始终正确

### 应用场景
- ✅ 系统自动切换输入法时立即恢复
- ✅ 其他软件强制切换输入法时立即纠正
- ✅ 用户手动切换输入法时自动恢复为配置状态
- ✅ 500毫秒内任何输入法状态变化都会被检测并纠正

## 快捷键说明

- **Alt+M**：切换软件总开关（启用/禁用输入法控制）
- **Alt+S**：在中文模式和英文模式之间切换

> 💡 **提示**：可以通过编辑配置文件自定义快捷键组合

## 使用方法

### 1. 快速开始
1. 下载最新版本的发布包
2. 解压并运行 `ime-controller.exe`
3. 程序会自动在系统托盘显示图标：
   - 红色图标：软件功能已启用
   - 蓝色图标：软件功能已禁用

### 2. 基本操作
- **右键托盘图标**：打开设置菜单
- **设置功能开关**：启用/禁用软件功能
- **选择输入法模式**：
  - 强制中文模式：锁定为中文输入
  - 强制英文模式：锁定为英文输入
- **开机自启动**：设置程序随系统启动

### 3. 高级配置
- **查看快捷键设置**：显示当前快捷键配置和修改方法
- **打开配置目录**：快速访问配置文件所在文件夹
- **重新加载配置**：修改配置文件后刷新设置
- **显示通知开关**：控制是否显示状态切换通知

## 配置文件详解

配置文件位置：`程序目录/config.json`

```json
{
  "enabled": true,
  "autostart": false,
  "excluded_apps": ["ime-controller.exe"],
  "hotkey_toggle": "Alt+M",
  "hotkey_switch_mode": "Alt+S",
  "ime_mode": "ChineseOnly",
  "master_switch": true,
  "show_notifications": false
}
```

### 配置项说明

| 配置项 | 类型 | 说明 | 可选值 |
|--------|------|------|--------|
| `enabled` | 布尔 | 软件是否启用 | `true` / `false` |
| `autostart` | 布尔 | 开机自启动 | `true` / `false` |
| `excluded_apps` | 数组 | 排除的应用程序列表 | 应用程序名称数组 |
| `hotkey_toggle` | 字符串 | 总开关快捷键 | 如 `"Alt+M"`, `"Ctrl+F1"` |
| `hotkey_switch_mode` | 字符串 | 模式切换快捷键 | 如 `"Alt+S"`, `"Shift+F2"` |
| `ime_mode` | 字符串 | 输入法模式 | `"ChineseOnly"` / `"EnglishOnly"` |
| `master_switch` | 布尔 | 主开关状态 | `true` / `false` |
| `show_notifications` | 布尔 | 显示通知 | `true` / `false` |

### 快捷键格式

支持的修饰键：`Alt`, `Ctrl`, `Shift`, `Win`
支持的按键：`A-Z`, `F1-F12`, `Space`, `Enter`, `Esc`, `Tab`, `Backspace`

示例：
- `"Alt+S"` - Alt + S
- `"Ctrl+Shift+F"` - Ctrl + Shift + F
- `"Win+Space"` - Windows键 + 空格

## 系统要求

- **操作系统**：Windows 10/11
- **输入法**：微软拼音输入法（推荐）或其他支持 WM_IME_CONTROL 的输入法
- **权限**：无需管理员权限

## 编译方法

### 环境要求
- Rust 开发环境 (1.70+)
- Windows SDK
- Visual Studio Build Tools 或 Visual Studio 2022

### 编译步骤

1. 克隆仓库：
```bash
git clone https://github.com/rpeng666/ime-controller.git
cd ime-controller
```

2. 编译项目：
```powershell
# 在 Visual Studio Developer Command Prompt 中执行
cargo build --release
```

3. 生成的可执行文件位于：`target/release/ime-controller.exe`

## 故障排除

### 热键不起作用
1. 检查是否有其他软件占用了相同的快捷键
2. 尝试修改配置文件中的快捷键组合
3. 右键托盘图标 → "重新加载配置"

### 开机自启动失败
1. 确保程序有足够的权限写入注册表
2. 检查杀毒软件是否阻止了注册表修改
3. 查看日志文件了解具体错误信息

### 输入法切换无效
1. 确认当前使用的是微软拼音输入法
2. 检查软件功能是否已启用（托盘图标应为彩色）
3. 尝试手动切换一次模式

## 更新日志

### v1.2.0 (当前版本)
- ✨ 新增人性化的字符串格式快捷键配置
- ✨ 新增开机自启动时的热键注册重试机制
- ✨ 新增通知开关，可选择是否显示状态切换通知
- ✨ 新增配置热重载功能
- 🔧 优化托盘图标动态切换逻辑
- 🔧 简化热键操作，单一快捷键切换中英文模式
- 🐛 修复开机自启动时热键注册失败的问题
- 🐛 修复重复的热键处理代码

## 贡献指南

欢迎提交 Pull Request 或 Issue！

### 开发指南
1. Fork 本仓库
2. 创建功能分支：`git checkout -b feature/your-feature`
3. 提交更改：`git commit -am 'Add your feature'`
4. 推送分支：`git push origin feature/your-feature`
5. 提交 Pull Request

## 致谢

感谢所有为此项目贡献代码和建议的开发者们！
